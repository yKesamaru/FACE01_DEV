<!DOCTYPE html>
<html class="writer-html5" lang="ja" data-content_root="../../">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>face01lib.utils &mdash; FACE01 3.0.02 ドキュメント</title>
      <link rel="stylesheet" type="text/css" href="../../_static/pygments.css?v=80d5e7a1" />
      <link rel="stylesheet" type="text/css" href="../../_static/css/theme.css?v=19f00094" />

  
    <link rel="shortcut icon" href="https://raw.githubusercontent.com/yKesamaru/FACE01_DEV/master/assets/images/Logo.ico"/>
  <!--[if lt IE 9]>
    <script src="../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script src="../../_static/jquery.js?v=5d32c60e"></script>
        <script src="../../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
        <script src="../../_static/documentation_options.js?v=ebc0197d"></script>
        <script src="../../_static/doctools.js?v=9a2dae69"></script>
        <script src="../../_static/sphinx_highlight.js?v=dc90522c"></script>
        <script src="../../_static/translations.js?v=91613774"></script>
    <script src="../../_static/js/theme.js"></script>
    <link rel="search" type="application/opensearchdescription+xml"
          title="FACE01 3.0.02 ドキュメント 内を検索"
          href="../../_static/opensearch.xml"/>
    <link rel="index" title="索引" href="../../genindex.html" />
    <link rel="search" title="検索" href="../../search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../../index.html" class="icon icon-home">
            FACE01
              <img src="https://raw.githubusercontent.com/yKesamaru/FACE01_DEV/master/assets/images/Logo_dist.png" class="logo" alt="Logo"/>
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">ドキュメント:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../step_by_step.html">ステップ・バイ・ステップ</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../example.html">example package</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../face01lib.html">face01lib package</a></li>
<li class="toctree-l1"><a class="reference external" href="https://github.com/yKesamaru/FACE01_DEV">GitHub</a></li>
<li class="toctree-l1"><a class="reference external" href="https://tokai-kaoninsho.com/">Tokai-kaoninsho</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">FACE01</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="../index.html">モジュールコード</a></li>
      <li class="breadcrumb-item active">face01lib.utils</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <h1>face01lib.utils のソースコード</h1><div class="highlight"><pre>
<span></span><span class="sd">&quot;&quot;&quot;License for the Code.</span>

<span class="sd">Copyright Owner: Yoshitsugu Kesamaru</span>
<span class="sd">Please refer to the separate license file for the license of the code.</span>

<span class="sd">The utils class.</span>

<span class="sd">When creating a deep learning model, we usually perform data augmentation processing to increase the base data.</span>
<span class="sd">In general, multiple aberrations that occur are mainly corrected by calibration. However, as far as I have seen, heard and experienced, it is &quot;common way&quot; that it is not calibrated (except for strong face recognition). As long as we use the normal model, this leads to a large accuracy loss.</span>

<span class="sd">    .. image:: ../docs/img/face_distortion.gif</span>
<span class="sd">        :scale: 50%</span>
<span class="sd">        :alt: Face distortion.</span>
<span class="sd">    Image taken from https://imgur.com/VdKIQqF</span>

<span class="sd">    .. image:: ../docs/img/face_distort_and_model.png</span>
<span class="sd">        :scale: 50%</span>
<span class="sd">        :alt: Image taken from https://tokai-kaoninsho.com</span>

<span class="sd">By using the utils.distort_barrel() method, we believe that we can greatly ensure the robustness of distortion caused by the camera lens.</span>

<span class="sd">    .. image:: ../docs/img/woman-1.gif</span>
<span class="sd">        :scale: 50%</span>
<span class="sd">        :alt: Image taken from https://tokai-kaoninsho.com</span>

<span class="sd">    .. image:: ../docs/img/distort_barrel.png</span>
<span class="sd">        :scale: 50%</span>
<span class="sd">        :alt: Image taken from https://tokai-kaoninsho.com</span>


<span class="sd">Note:</span>
<span class="sd">    **ImageMagick must be installed on your system.**</span>
<span class="sd">    - See ImageMagick https://imagemagick.org/script/download.php</span>
<span class="sd">&quot;&quot;&quot;</span>

<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">pathlib</span>
<span class="kn">import</span> <span class="nn">re</span>
<span class="kn">import</span> <span class="nn">shutil</span>
<span class="kn">import</span> <span class="nn">subprocess</span>
<span class="kn">import</span> <span class="nn">time</span>
<span class="kn">from</span> <span class="nn">glob</span> <span class="kn">import</span> <span class="n">glob</span>
<span class="kn">from</span> <span class="nn">os</span> <span class="kn">import</span> <span class="n">environ</span>
<span class="kn">from</span> <span class="nn">sys</span> <span class="kn">import</span> <span class="n">exit</span>
<span class="kn">from</span> <span class="nn">traceback</span> <span class="kn">import</span> <span class="n">format_exc</span>
<span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">List</span><span class="p">,</span> <span class="n">Tuple</span>

<span class="kn">import</span> <span class="nn">cv2</span>
<span class="kn">import</span> <span class="nn">dlib</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">numpy.typing</span> <span class="k">as</span> <span class="nn">npt</span>
<span class="kn">from</span> <span class="nn">PIL</span> <span class="kn">import</span> <span class="n">ImageFile</span>
<span class="kn">from</span> <span class="nn">tqdm</span> <span class="kn">import</span> <span class="n">tqdm</span>

<span class="kn">from</span> <span class="nn">face01lib.api</span> <span class="kn">import</span> <span class="n">Dlib_api</span>
<span class="kn">from</span> <span class="nn">face01lib.Calc</span> <span class="kn">import</span> <span class="n">Cal</span>
<span class="kn">from</span> <span class="nn">face01lib.logger</span> <span class="kn">import</span> <span class="n">Logger</span>
<span class="kn">from</span> <span class="nn">face01lib.video_capture</span> <span class="kn">import</span> <span class="n">VidCap</span>

<span class="kn">from</span> <span class="nn">.models</span> <span class="kn">import</span> <span class="n">Models</span>

<span class="n">VidCap_obj</span> <span class="o">=</span> <span class="n">VidCap</span><span class="p">()</span>


<span class="n">ImageFile</span><span class="o">.</span><span class="n">LOAD_TRUNCATED_IMAGES</span> <span class="o">=</span> <span class="kc">True</span>
<span class="sd">&quot;&quot;&quot;TODO #18 opencvの環境変数変更 要調査&quot;&quot;&quot;</span>
<span class="c1"># environ[&quot;OPENCV_FFMPEG_CAPTURE_OPTIONS&quot;] = &quot;rtsp_transport;udp&quot;</span>
<span class="n">environ</span><span class="p">[</span><span class="s2">&quot;OPENCV_FFMPEG_CAPTURE_OPTIONS&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;rtsp_transport;tcp&quot;</span>


<div class="viewcode-block" id="Utils">
<a class="viewcode-back" href="../../face01lib.html#face01lib.utils.Utils">[ドキュメント]</a>
<span class="k">class</span> <span class="nc">Utils</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Utils class.</span>

<span class="sd">    contains convenience methods</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">log_level</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;info&#39;</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;init.</span>

<span class="sd">        Args:</span>
<span class="sd">            log_level (str, optional): Receive log level value. Defaults to &#39;info&#39;.</span>

<span class="sd">        Return:</span>
<span class="sd">                None</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Setup logger: common way</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log_level</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">log_level</span>
        <span class="kn">import</span> <span class="nn">os.path</span>
        <span class="n">name</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="vm">__name__</span>
        <span class="nb">dir</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="vm">__file__</span><span class="p">)</span>
        <span class="n">parent_dir</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="nb">dir</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span> <span class="o">=</span> <span class="n">Logger</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">log_level</span><span class="p">)</span><span class="o">.</span><span class="n">logger</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">parent_dir</span><span class="p">)</span>

        <span class="n">Cal</span><span class="p">()</span><span class="o">.</span><span class="n">cal_specify_date</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="p">)</span>

        <span class="c1"># Dlib</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="kn">from</span> <span class="nn">.models</span> <span class="kn">import</span> <span class="n">Models</span>
            <span class="n">models_obj</span> <span class="o">=</span> <span class="n">Models</span><span class="p">()</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;Failed to import dlib model&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;-&quot;</span> <span class="o">*</span> <span class="mi">20</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">format_exc</span><span class="p">(</span><span class="n">limit</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">chain</span><span class="o">=</span><span class="kc">True</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;-&quot;</span> <span class="o">*</span> <span class="mi">20</span><span class="p">)</span>
            <span class="n">exit</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">face_detector</span> <span class="o">=</span> <span class="n">dlib</span><span class="o">.</span><span class="n">get_frontal_face_detector</span><span class="p">()</span>  <span class="c1"># type: ignore</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">predictor_5_point_model</span> <span class="o">=</span> <span class="n">models_obj</span><span class="o">.</span><span class="n">pose_predictor_five_point_model_location</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pose_predictor_5_point</span> <span class="o">=</span> <span class="n">dlib</span><span class="o">.</span><span class="n">shape_predictor</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">predictor_5_point_model</span><span class="p">)</span>  <span class="c1"># type: ignore</span>

<div class="viewcode-block" id="Utils.get_files_from_path">
<a class="viewcode-back" href="../../face01lib.html#face01lib.utils.Utils.get_files_from_path">[ドキュメント]</a>
    <span class="k">def</span> <span class="nf">get_files_from_path</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">path</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">contain</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;resize&quot;</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Receive path, return files.</span>

<span class="sd">        Args:</span>
<span class="sd">            path (str): Directory path</span>
<span class="sd">            contain (str): Contain word. If you want to get all files, set `*`. Default is `resize`.</span>

<span class="sd">        Returns:</span>
<span class="sd">            list: Files in received path (absolute path)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">path</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">path</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">contain</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">contain</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">contain</span> <span class="o">==</span> <span class="s1">&#39;*&#39;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">contain</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>

        <span class="n">files</span><span class="p">:</span> <span class="nb">list</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">files_png</span><span class="p">:</span> <span class="nb">list</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">files_jpg</span><span class="p">:</span> <span class="nb">list</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">files_jpeg</span><span class="p">:</span> <span class="nb">list</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">files_png</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">glob</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">path</span> <span class="o">+</span> <span class="s2">&quot;/*&quot;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">contain</span> <span class="o">+</span> <span class="s2">&quot;*&quot;</span> <span class="o">+</span> <span class="s2">&quot;*.png&quot;</span><span class="p">))</span>
        <span class="n">files_jpg</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">glob</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">path</span> <span class="o">+</span> <span class="s2">&quot;/*&quot;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">contain</span> <span class="o">+</span> <span class="s2">&quot;*&quot;</span> <span class="o">+</span> <span class="s2">&quot;*.jpg&quot;</span><span class="p">))</span>
        <span class="n">files_jpeg</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
            <span class="n">glob</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">path</span> <span class="o">+</span> <span class="s2">&quot;/*&quot;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">contain</span> <span class="o">+</span> <span class="s2">&quot;*&quot;</span> <span class="o">+</span> <span class="s2">&quot;*.jpeg&quot;</span><span class="p">))</span>
        <span class="n">files</span> <span class="o">=</span> <span class="n">files_png</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">files_jpg</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">files_jpeg</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">files</span></div>


    <span class="c1"># Resize to specified size while maintaining aspect ratio</span>
<div class="viewcode-block" id="Utils.align_and_resize_maintain_aspect_ratio">
<a class="viewcode-back" href="../../face01lib.html#face01lib.utils.Utils.align_and_resize_maintain_aspect_ratio">[ドキュメント]</a>
    <span class="k">def</span> <span class="nf">align_and_resize_maintain_aspect_ratio</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">path</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">upper_limit_length</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">1024</span><span class="p">,</span>
        <span class="n">padding</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.4</span><span class="p">,</span>
        <span class="n">size</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">224</span><span class="p">,</span>
        <span class="n">contain</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;入力画像をアラインメントしてリサイズ（アスペクト比を維持）.</span>

<span class="sd">        Args:</span>
<span class="sd">            path (str): ファイル名を含むファイルパス。(&#39;.jpg&#39; または &#39;.jpeg&#39; または &#39;.png&#39;。これらは小文字でなければなりません。) パスがディレクトリの場合、そのディレクトリに含まれるすべてのファイルが対象です。</span>
<span class="sd">            upper_limit_length (int, optional): 幅の上限長さ。デフォルトは1024。</span>
<span class="sd">            padding (float, optional): 顔の周りのパディング。大 = 0.8、中 = 0.4、小 = 0.25、非常に小さい = 0.1。デフォルトは0.4。</span>
<span class="sd">            size (int, optional): 画像データのリサイズ後のサイズ。デフォルトは224。</span>
<span class="sd">            contain (str, optional): ディレクトリ内のファイル名に含まれる単語。</span>

<span class="sd">        Return:</span>
<span class="sd">            error_files (list): アラインメントとリサイズに失敗したファイルのリスト。</span>

<span class="sd">        Result:</span>
<span class="sd">            .. image:: ../docs/img/face_alignment.png</span>
<span class="sd">                :scale: 50%</span>
<span class="sd">                :alt: Image taken from https://tokai-kaoninsho.com</span>

<span class="sd">        Note:</span>
<span class="sd">            入力画像ファイルの幅が&#39;1024px&#39;を超える場合、アスペクト比を維持しながら&#39;1024px&#39;にリサイズされます。</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">path</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">path</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">upper_limit_length</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="n">upper_limit_length</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">padding</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="n">padding</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">size</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="n">size</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">contain</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">contain</span>

        <span class="n">files</span><span class="p">:</span> <span class="nb">list</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">error_files</span><span class="p">:</span> <span class="nb">list</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="s1">&#39;.jpg&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">path</span><span class="p">:</span>
            <span class="n">files</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">path</span><span class="p">)</span>
        <span class="k">elif</span> <span class="s1">&#39;.jpeg&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">path</span><span class="p">:</span>
            <span class="n">files</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">path</span><span class="p">)</span>
        <span class="k">elif</span> <span class="s1">&#39;.png&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">path</span><span class="p">:</span>
            <span class="n">files</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">path</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">files</span><span class="p">:</span> <span class="nb">list</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_files_from_path</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">path</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">contain</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">file_path</span> <span class="ow">in</span> <span class="n">files</span><span class="p">:</span>
            <span class="c1"># file_name = file_path.split(&#39;/&#39;)[-1]</span>
            <span class="c1"># count faces</span>
            <span class="n">face_cnt</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span>

            <span class="c1"># Load image</span>
            <span class="c1"># img: npt.NDArray[np.uint8] = Dlib_api().load_image_file(file_path, mode=&#39;RGB&#39;)</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">img</span><span class="p">:</span> <span class="n">npt</span><span class="o">.</span><span class="n">NDArray</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">uint8</span><span class="p">]</span> <span class="o">=</span> <span class="n">dlib</span><span class="o">.</span><span class="n">load_rgb_image</span><span class="p">(</span>
                    <span class="n">file_path</span><span class="p">)</span>  <span class="c1"># type: ignore</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">file_path</span> <span class="o">+</span> <span class="s2">&quot;: cannot load image&quot;</span><span class="p">)</span>
                <span class="n">error_files</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">file_path</span><span class="p">)</span>
                <span class="k">continue</span>

            <span class="c1"># ISSUE #3: Resize input image to 1024px while maintaining aspect ratio.</span>
            <span class="k">if</span> <span class="n">img</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">upper_limit_length</span> <span class="ow">or</span> <span class="n">img</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">upper_limit_length</span><span class="p">:</span>
                <span class="n">img</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">resize_image</span><span class="p">(</span><span class="n">img</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">upper_limit_length</span><span class="p">)</span>
            <span class="c1"># DEBUG</span>
            <span class="c1"># VidCap_obj.frame_imshow_for_debug(img)</span>

            <span class="n">dets</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">face_detector</span><span class="p">(</span><span class="n">img</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
            <span class="n">num_faces</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">dets</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">num_faces</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="c1"># Flip image horizontally</span>
                <span class="n">horizontal_flip_img</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">flip</span><span class="p">(</span><span class="n">img</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">face_detector</span><span class="p">(</span><span class="n">horizontal_flip_img</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">file_path</span> <span class="o">+</span> <span class="s2">&quot;: no face&quot;</span><span class="p">)</span>
                    <span class="n">error_files</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">file_path</span><span class="p">)</span>
                    <span class="c1"># DEBUG</span>
                    <span class="c1"># VidCap_obj.frame_imshow_for_debug(horizontal_flip_img)</span>
                    <span class="k">continue</span>

            <span class="n">faces</span> <span class="o">=</span> <span class="n">dlib</span><span class="o">.</span><span class="n">full_object_detections</span><span class="p">()</span>  <span class="c1"># type: ignore</span>

            <span class="k">for</span> <span class="n">detection</span> <span class="ow">in</span> <span class="n">dets</span><span class="p">:</span>
                <span class="n">landmark</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pose_predictor_5_point</span><span class="p">(</span><span class="n">img</span><span class="p">,</span> <span class="n">detection</span><span class="p">)</span>
                <span class="n">faces</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">landmark</span><span class="p">)</span>

            <span class="c1"># Get a calibrated image</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">images</span> <span class="o">=</span> <span class="n">dlib</span><span class="o">.</span><span class="n">get_face_chips</span><span class="p">(</span><span class="n">img</span><span class="p">,</span> <span class="n">faces</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">size</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">padding</span><span class="p">)</span>  <span class="c1"># type: ignore</span>
                <span class="c1"># [get_face_chip](http://dlib.net/python/index.html#dlib_pybind11.get_face_chip) about padding.</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="k">continue</span>

            <span class="c1"># img = images[0]</span>
            <span class="k">for</span> <span class="n">img</span> <span class="ow">in</span> <span class="n">images</span><span class="p">:</span>
                <span class="n">img</span> <span class="o">=</span> <span class="n">img</span><span class="p">[:,</span> <span class="p">:,</span> <span class="p">::</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>  <span class="c1"># bgr to rgb</span>
                <span class="n">cv2</span><span class="o">.</span><span class="n">imwrite</span><span class="p">(</span><span class="n">file_path</span> <span class="o">+</span> <span class="s2">&quot;_&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">face_cnt</span><span class="p">)</span> <span class="o">+</span>
                            <span class="s2">&quot;_align_resize.png&quot;</span><span class="p">,</span> <span class="n">img</span><span class="p">)</span>
                <span class="n">face_cnt</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="k">return</span> <span class="n">error_files</span></div>


<div class="viewcode-block" id="Utils.create_concat_images">
<a class="viewcode-back" href="../../face01lib.html#face01lib.utils.Utils.create_concat_images">[ドキュメント]</a>
    <span class="k">def</span> <span class="nf">create_concat_images</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">img</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">size</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">224</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Create tile images.</span>

<span class="sd">        Args:</span>
<span class="sd">            img (str): absolute file path</span>
<span class="sd">            size (int): image size. Default is 224.</span>

<span class="sd">        Result:</span>
<span class="sd">            .. image:: ../docs/img/make_concat_image.png</span>
<span class="sd">                    :scale: 50%</span>
<span class="sd">                    :alt: Image taken from https://tokai-kaoninsho.com</span>

<span class="sd">            .. image:: ../docs/img/distort_concat_images.png</span>
<span class="sd">                    :scale: 50%</span>
<span class="sd">                    :alt: Image taken from https://tokai-kaoninsho.com</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">img</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">img</span>

        <span class="n">path</span><span class="p">,</span> <span class="n">file_name</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">img</span><span class="p">)</span>

        <span class="n">p_append</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;convert +append&quot;</span>
        <span class="n">m_append</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;convert -append&quot;</span>
        <span class="n">sp</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot; &quot;</span>
        <span class="n">bk_png</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;/home/terms/bin/FACE01/images/224x224.png&quot;</span>
        <span class="n">concat_png</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;concat.png&quot;</span>
        <span class="n">bb_png</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;bb.png&quot;</span>

        <span class="c1"># pwd = os.getcwd()</span>

        <span class="c1"># top-left</span>
        <span class="n">subprocess</span><span class="o">.</span><span class="n">run</span><span class="p">([</span><span class="n">p_append</span> <span class="o">+</span> <span class="n">sp</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">img</span> <span class="o">+</span> <span class="n">sp</span> <span class="o">+</span> <span class="n">bk_png</span> <span class="o">+</span> <span class="n">sp</span> <span class="o">+</span> <span class="n">concat_png</span><span class="p">],</span> <span class="n">shell</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">subprocess</span><span class="o">.</span><span class="n">run</span><span class="p">([</span><span class="n">p_append</span> <span class="o">+</span> <span class="n">sp</span> <span class="o">+</span> <span class="n">bk_png</span> <span class="o">+</span> <span class="n">sp</span> <span class="o">+</span> <span class="n">bk_png</span> <span class="o">+</span> <span class="n">sp</span> <span class="o">+</span> <span class="n">bb_png</span><span class="p">],</span> <span class="n">shell</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">subprocess</span><span class="o">.</span><span class="n">run</span><span class="p">([</span><span class="n">m_append</span> <span class="o">+</span> <span class="n">sp</span> <span class="o">+</span> <span class="n">concat_png</span> <span class="o">+</span> <span class="n">sp</span> <span class="o">+</span> <span class="n">bb_png</span> <span class="o">+</span> <span class="n">sp</span> <span class="o">+</span> <span class="n">path</span> <span class="o">+</span> <span class="s2">&quot;/concat_images/&quot;</span> <span class="o">+</span> <span class="n">file_name</span> <span class="o">+</span> <span class="s2">&quot;_top_left.png&quot;</span><span class="p">],</span> <span class="n">shell</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="c1"># top_right</span>
        <span class="n">subprocess</span><span class="o">.</span><span class="n">run</span><span class="p">([</span><span class="n">p_append</span> <span class="o">+</span> <span class="n">sp</span> <span class="o">+</span> <span class="n">bk_png</span> <span class="o">+</span> <span class="n">sp</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">img</span> <span class="o">+</span> <span class="n">sp</span> <span class="o">+</span> <span class="n">concat_png</span><span class="p">],</span> <span class="n">shell</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">subprocess</span><span class="o">.</span><span class="n">run</span><span class="p">([</span><span class="n">p_append</span> <span class="o">+</span> <span class="n">sp</span> <span class="o">+</span> <span class="n">bk_png</span> <span class="o">+</span> <span class="n">sp</span> <span class="o">+</span> <span class="n">bk_png</span> <span class="o">+</span> <span class="n">sp</span> <span class="o">+</span> <span class="n">bb_png</span><span class="p">],</span> <span class="n">shell</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">subprocess</span><span class="o">.</span><span class="n">run</span><span class="p">([</span><span class="n">m_append</span> <span class="o">+</span> <span class="n">sp</span> <span class="o">+</span> <span class="n">concat_png</span> <span class="o">+</span> <span class="n">sp</span> <span class="o">+</span> <span class="n">bb_png</span> <span class="o">+</span> <span class="n">sp</span> <span class="o">+</span> <span class="n">path</span> <span class="o">+</span> <span class="s2">&quot;/concat_images/&quot;</span> <span class="o">+</span> <span class="n">file_name</span> <span class="o">+</span> <span class="s2">&quot;_top_right.png&quot;</span><span class="p">],</span> <span class="n">shell</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="c1"># bottom_left</span>
        <span class="n">subprocess</span><span class="o">.</span><span class="n">run</span><span class="p">([</span><span class="n">p_append</span> <span class="o">+</span> <span class="n">sp</span> <span class="o">+</span> <span class="n">bk_png</span> <span class="o">+</span> <span class="n">sp</span> <span class="o">+</span> <span class="n">bk_png</span> <span class="o">+</span> <span class="n">sp</span> <span class="o">+</span> <span class="n">bb_png</span><span class="p">],</span> <span class="n">shell</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">subprocess</span><span class="o">.</span><span class="n">run</span><span class="p">([</span><span class="n">p_append</span> <span class="o">+</span> <span class="n">sp</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">img</span> <span class="o">+</span> <span class="n">sp</span> <span class="o">+</span> <span class="n">bk_png</span> <span class="o">+</span> <span class="n">sp</span> <span class="o">+</span> <span class="n">concat_png</span><span class="p">],</span> <span class="n">shell</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">subprocess</span><span class="o">.</span><span class="n">run</span><span class="p">([</span><span class="n">m_append</span> <span class="o">+</span> <span class="n">sp</span> <span class="o">+</span> <span class="n">bb_png</span> <span class="o">+</span> <span class="n">sp</span> <span class="o">+</span> <span class="n">concat_png</span> <span class="o">+</span> <span class="n">sp</span> <span class="o">+</span> <span class="n">path</span> <span class="o">+</span> <span class="s2">&quot;/concat_images/&quot;</span> <span class="o">+</span> <span class="n">file_name</span> <span class="o">+</span> <span class="s2">&quot;_bottom_left.png&quot;</span><span class="p">],</span> <span class="n">shell</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="c1"># bottom_right</span>
        <span class="n">subprocess</span><span class="o">.</span><span class="n">run</span><span class="p">([</span><span class="n">p_append</span> <span class="o">+</span> <span class="n">sp</span> <span class="o">+</span> <span class="n">bk_png</span> <span class="o">+</span> <span class="n">sp</span> <span class="o">+</span> <span class="n">bk_png</span> <span class="o">+</span> <span class="n">sp</span> <span class="o">+</span> <span class="n">bb_png</span><span class="p">],</span> <span class="n">shell</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">subprocess</span><span class="o">.</span><span class="n">run</span><span class="p">([</span><span class="n">p_append</span> <span class="o">+</span> <span class="n">sp</span> <span class="o">+</span> <span class="n">bk_png</span> <span class="o">+</span> <span class="n">sp</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">img</span> <span class="o">+</span> <span class="n">sp</span> <span class="o">+</span> <span class="n">concat_png</span><span class="p">],</span> <span class="n">shell</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">subprocess</span><span class="o">.</span><span class="n">run</span><span class="p">([</span><span class="n">m_append</span> <span class="o">+</span> <span class="n">sp</span> <span class="o">+</span> <span class="n">bb_png</span> <span class="o">+</span> <span class="n">sp</span> <span class="o">+</span> <span class="n">concat_png</span> <span class="o">+</span> <span class="n">sp</span> <span class="o">+</span> <span class="n">path</span> <span class="o">+</span> <span class="s2">&quot;/concat_images/&quot;</span> <span class="o">+</span> <span class="n">file_name</span> <span class="o">+</span> <span class="s2">&quot;_bottom_right.png&quot;</span><span class="p">],</span> <span class="n">shell</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="c1"># remove</span>
        <span class="n">subprocess</span><span class="o">.</span><span class="n">run</span><span class="p">([</span><span class="s2">&quot;rm&quot;</span> <span class="o">+</span> <span class="n">sp</span> <span class="o">+</span> <span class="n">concat_png</span> <span class="o">+</span> <span class="n">sp</span> <span class="o">+</span> <span class="n">bb_png</span><span class="p">],</span> <span class="n">shell</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span></div>


<div class="viewcode-block" id="Utils.distort_barrel">
<a class="viewcode-back" href="../../face01lib.html#face01lib.utils.Utils.distort_barrel">[ドキュメント]</a>
    <span class="k">def</span> <span class="nf">distort_barrel</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">dir_path</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">align_and_resize_bool</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
        <span class="n">size</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">224</span><span class="p">,</span>
        <span class="n">padding</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.1</span><span class="p">,</span>
        <span class="n">initial_value</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="o">-</span><span class="mf">0.1</span><span class="p">,</span>
        <span class="n">closing_value</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.1</span><span class="p">,</span>
        <span class="n">step_value</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.1</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Distort barrel.</span>

<span class="sd">        Takes a path which contained png, jpg, jpeg files in the directory,</span>
<span class="sd">        distort barrel and saves them.</span>

<span class="sd">        Args:</span>
<span class="sd">            dir_path (str): absolute path of target directory.</span>
<span class="sd">            align_and_resize_bool (bool, optional): Whether to align and resize. Defaults to False.</span>
<span class="sd">            size (int, optional): Width and height. Defaults to 224.</span>
<span class="sd">            padding (float, optional): Padding. Defaults to 0.1.</span>
<span class="sd">            initial_value (float): Initial value. Default is -0.1.</span>
<span class="sd">            closing_value (float): Closing value. Default is 0.1.</span>
<span class="sd">            step_value (float): Step value. Default is 0.1.</span>

<span class="sd">        Return:</span>
<span class="sd">            Path list of processed files.</span>

<span class="sd">        Note:</span>
<span class="sd">            **ImageMagick must be installed on your system.**</span>
<span class="sd">            - See ImageMagick https://imagemagick.org/script/download.php</span>

<span class="sd">        Result:</span>
<span class="sd">            .. image:: ../docs/img/distort_barrel.png</span>
<span class="sd">                :scale: 50%</span>
<span class="sd">                :alt: Image taken from https://tokai-kaoninsho.com</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">path</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">dir_path</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">align_and_resize_bool</span> <span class="o">=</span> <span class="n">align_and_resize_bool</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">size</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="n">size</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">padding</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="n">padding</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">initial_value</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="n">initial_value</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">closing_value</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="n">closing_value</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">step_value</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="n">step_value</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">align_and_resize_bool</span> <span class="o">==</span> <span class="kc">True</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">align_and_resize_maintain_aspect_ratio</span><span class="p">(</span>
                <span class="n">path</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">path</span><span class="p">,</span>
                <span class="n">padding</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">padding</span><span class="p">,</span>
                <span class="n">size</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">size</span><span class="p">,</span>
            <span class="p">)</span>

        <span class="c1"># Create tile images</span>
        <span class="n">os</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">path</span><span class="p">,</span> <span class="s2">&quot;concat_images&quot;</span><span class="p">))</span>

        <span class="n">files</span><span class="p">:</span> <span class="nb">list</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">files</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_files_from_path</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">path</span><span class="p">,</span> <span class="n">contain</span><span class="o">=</span><span class="s1">&#39;resize&#39;</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">file_path</span> <span class="ow">in</span> <span class="n">tqdm</span><span class="p">(</span><span class="n">files</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">create_concat_images</span><span class="p">(</span><span class="n">file_path</span><span class="p">)</span>

        <span class="c1"># Make float list</span>
        <span class="n">value_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">initial_value</span><span class="p">]</span>
        <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
            <span class="c1"># Increment value by distortion_value</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">initial_value</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">step_value</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">initial_value</span> <span class="o">==</span> <span class="mf">0.0</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">initial_value</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">closing_value</span><span class="p">:</span>
                <span class="k">break</span>
            <span class="n">value_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">initial_value</span><span class="p">)</span>

        <span class="c1"># Make barrel images</span>
        <span class="n">files</span> <span class="o">=</span> <span class="n">files</span> <span class="o">+</span> \
            <span class="bp">self</span><span class="o">.</span><span class="n">get_files_from_path</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">path</span><span class="p">,</span> <span class="s2">&quot;concat_images&quot;</span><span class="p">))</span>

        <span class="k">for</span> <span class="n">file_path</span> <span class="ow">in</span> <span class="n">tqdm</span><span class="p">(</span><span class="n">files</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">value_list</span><span class="p">:</span>
                <span class="n">cmd</span> <span class="o">=</span> <span class="s2">&quot;convert </span><span class="si">{}</span><span class="s2"> &quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">file_path</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39; -rotate -0&#39;</span>
                <span class="n">barrel_value</span> <span class="o">=</span> <span class="s2">&quot; -distort barrel &#39;0.0 0.0 </span><span class="si">{}</span><span class="s2">&#39;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
                <span class="n">output_image</span> <span class="o">=</span> <span class="s1">&#39; &#39;</span> <span class="o">+</span> <span class="n">file_path</span> <span class="o">+</span> \
                    <span class="s2">&quot;_lensD_</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">value</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;.png&quot;</span>
                <span class="n">cmd</span> <span class="o">=</span> <span class="n">cmd</span> <span class="o">+</span> <span class="n">barrel_value</span> <span class="o">+</span> <span class="n">output_image</span>
                <span class="n">res</span> <span class="o">=</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">run</span><span class="p">([</span><span class="n">cmd</span><span class="p">],</span> <span class="n">shell</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">align_and_resize_maintain_aspect_ratio</span><span class="p">(</span>
            <span class="n">path</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">path</span><span class="p">,</span>
            <span class="n">padding</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">padding</span><span class="p">,</span>
            <span class="n">size</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">size</span><span class="p">,</span>
            <span class="n">contain</span><span class="o">=</span><span class="s1">&#39;_top_&#39;</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">align_and_resize_maintain_aspect_ratio</span><span class="p">(</span>
            <span class="n">path</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">path</span><span class="p">,</span>
            <span class="n">padding</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">padding</span><span class="p">,</span>
            <span class="n">size</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">size</span><span class="p">,</span>
            <span class="n">contain</span><span class="o">=</span><span class="s1">&#39;_bottom_&#39;</span>
        <span class="p">)</span>

        <span class="n">cwp</span> <span class="o">=</span> <span class="n">pathlib</span><span class="o">.</span><span class="n">Path</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">path</span><span class="p">)</span>
        <span class="n">parent_dir</span> <span class="o">=</span> <span class="n">cwp</span><span class="o">.</span><span class="n">parent</span>
        <span class="n">face_images</span><span class="p">:</span> <span class="nb">list</span> <span class="o">=</span> <span class="n">glob</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">path</span> <span class="o">+</span> <span class="s2">&quot;/*_lensD_*.png_align_resize.png&quot;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">face_image</span> <span class="ow">in</span> <span class="n">face_images</span><span class="p">:</span>
            <span class="n">shutil</span><span class="o">.</span><span class="n">move</span><span class="p">(</span><span class="n">face_image</span><span class="p">,</span> <span class="n">parent_dir</span><span class="p">)</span>

        <span class="c1"># Remove trash files</span>
        <span class="n">shutil</span><span class="o">.</span><span class="n">rmtree</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">path</span><span class="p">)</span>

        <span class="c1"># Return file list</span>
        <span class="k">return</span> <span class="n">glob</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">parent_dir</span><span class="p">,</span> <span class="s1">&#39;*_lensD_*_align_resize.png&#39;</span><span class="p">))</span></div>


<div class="viewcode-block" id="Utils.get_jitter_image">
<a class="viewcode-back" href="../../face01lib.html#face01lib.utils.Utils.get_jitter_image">[ドキュメント]</a>
    <span class="k">def</span> <span class="nf">get_jitter_image</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">dir_path</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">num_jitters</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">10</span><span class="p">,</span>
        <span class="n">size</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">224</span><span class="p">,</span>
        <span class="n">disturb_color</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Jitter images at the specified path.</span>

<span class="sd">        Args:</span>
<span class="sd">            dir_path (str): path of target directory.</span>
<span class="sd">            num_jitters (int, optional): Number of jitters. Defaults to 10.</span>
<span class="sd">            size (int, optional): Resize image to size(px). Defaults to 224px.</span>
<span class="sd">            disturb_color (bool, optional): Disturb color. Defaults to True.</span>

<span class="sd">        Note:</span>
<span class="sd">        This method is based on davisking/dlib/python_example/face_jitter.py.</span>
<span class="sd">        https://github.com/davisking/dlib/blob/master/python_examples/face_jitter.py</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">path</span> <span class="o">=</span> <span class="n">dir_path</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">num_jitters</span> <span class="o">=</span> <span class="n">num_jitters</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">size</span> <span class="o">=</span> <span class="n">size</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">disturb_color</span> <span class="o">=</span> <span class="n">disturb_color</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">models_obj</span> <span class="o">=</span> <span class="n">Models</span><span class="p">()</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;Failed to import dlib model&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;-&quot;</span> <span class="o">*</span> <span class="mi">20</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">format_exc</span><span class="p">(</span><span class="n">limit</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">chain</span><span class="o">=</span><span class="kc">True</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;-&quot;</span> <span class="o">*</span> <span class="mi">20</span><span class="p">)</span>
            <span class="n">exit</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">face_detector</span> <span class="o">=</span> <span class="n">dlib</span><span class="o">.</span><span class="n">get_frontal_face_detector</span><span class="p">()</span>  <span class="c1"># type: ignore</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pose_predictor_5_point</span> <span class="o">=</span> <span class="n">dlib</span><span class="o">.</span><span class="n">shape_predictor</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">predictor_5_point_model</span><span class="p">)</span>  <span class="c1"># type: ignore</span>
        <span class="n">face_list</span><span class="p">:</span> <span class="nb">list</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_files_from_path</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">path</span><span class="p">,</span> <span class="n">contain</span><span class="o">=</span><span class="s1">&#39;*&#39;</span><span class="p">)</span>
        <span class="n">faces</span><span class="p">:</span> <span class="nb">list</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">file_name</span> <span class="ow">in</span> <span class="n">tqdm</span><span class="p">(</span><span class="n">face_list</span><span class="p">):</span>
            <span class="c1"># Load the image using dlib</span>
            <span class="n">img</span> <span class="o">=</span> <span class="n">dlib</span><span class="o">.</span><span class="n">load_rgb_image</span><span class="p">(</span><span class="n">file_name</span><span class="p">)</span>  <span class="c1"># type: ignore</span>
            <span class="c1"># Ask the detector to find the bounding boxes of each face.</span>
            <span class="n">dets</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">face_detector</span><span class="p">(</span><span class="n">img</span><span class="p">)</span>
            <span class="n">num_faces</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">dets</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">num_faces</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="c1"># Find the 5 face landmarks we need to do the alignment.</span>
            <span class="n">faces</span> <span class="o">=</span> <span class="n">dlib</span><span class="o">.</span><span class="n">full_object_detections</span><span class="p">()</span>  <span class="c1"># type: ignore</span>
            <span class="k">for</span> <span class="n">detection</span> <span class="ow">in</span> <span class="n">dets</span><span class="p">:</span>
                <span class="n">faces</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pose_predictor_5_point</span><span class="p">(</span><span class="n">img</span><span class="p">,</span> <span class="n">detection</span><span class="p">))</span>
            <span class="c1"># Get the aligned face image and show it</span>
            <span class="n">image</span> <span class="o">=</span> <span class="n">dlib</span><span class="o">.</span><span class="n">get_face_chip</span><span class="p">(</span><span class="n">img</span><span class="p">,</span> <span class="n">faces</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">size</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">size</span><span class="p">,</span> <span class="n">padding</span><span class="o">=</span><span class="mf">0.4</span><span class="p">)</span>  <span class="c1"># type: ignore</span>
            <span class="c1"># Jitter images with data augmentation</span>
            <span class="n">jittered_images</span> <span class="o">=</span> <span class="n">dlib</span><span class="o">.</span><span class="n">jitter_image</span><span class="p">(</span><span class="n">image</span><span class="p">,</span> <span class="n">num_jitters</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">num_jitters</span><span class="p">,</span> <span class="n">disturb_colors</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">disturb_color</span><span class="p">)</span>  <span class="c1"># type: ignore</span>
            <span class="c1"># Save jittered images</span>
            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">jittered_image</span> <span class="ow">in</span> <span class="p">(</span><span class="nb">enumerate</span><span class="p">(</span><span class="n">jittered_images</span><span class="p">)):</span>
                <span class="c1"># save image</span>
                <span class="n">cv2</span><span class="o">.</span><span class="n">imwrite</span><span class="p">(</span><span class="n">file_name</span> <span class="o">+</span> <span class="s2">&quot;_jitter_</span><span class="si">{}</span><span class="s2">.png&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">i</span><span class="p">),</span> <span class="n">jittered_image</span><span class="p">)</span></div>


<div class="viewcode-block" id="Utils.get_face_encoding">
<a class="viewcode-back" href="../../face01lib.html#face01lib.utils.Utils.get_face_encoding">[ドキュメント]</a>
    <span class="k">def</span> <span class="nf">get_face_encoding</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">deep_learning_model</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
        <span class="n">image_path</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">num_jitters</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
        <span class="n">number_of_times_to_upsample</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
        <span class="n">mode</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;cnn&#39;</span><span class="p">,</span>
        <span class="n">model</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;small&#39;</span>
    <span class="p">):</span>
        <span class="c1"># ) -&gt; npt.NDArray[np.float32] or None:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;get_face_encoding : get face encoding from image file.</span>

<span class="sd">        Args:</span>
<span class="sd">            deep_learning_model (int): dli model: 0, efficientnetv2_arcface model: 1</span>
<span class="sd">            image_path (str): image file path.</span>
<span class="sd">            num_jitters (int, optional): Number of jitters. Defaults to 0.</span>
<span class="sd">            number_of_times_to_upsample (int, optional): Number of times to upsample the image looking for faces. Defaults to 0.</span>
<span class="sd">            mode (str, optional): cnn or hog. Defaults to &#39;cnn&#39;.</span>
<span class="sd">            model (str, optional): small or large. Defaults to &#39;small&#39;.</span>

<span class="sd">        Returns:</span>
<span class="sd">            NDArray data (npt.NDArray[np.float32]): face encoding data or None if not detected face.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">deep_learning_model</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="n">deep_learning_model</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">image_path</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">image_path</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">num_jitters</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="n">num_jitters</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">number_of_times_to_upsample</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="n">number_of_times_to_upsample</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mode</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">mode</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">model</span>

        <span class="n">Dlib_api_obj</span> <span class="o">=</span> <span class="n">Dlib_api</span><span class="p">()</span>

        <span class="n">dir_file_ndarray</span> <span class="o">=</span> <span class="n">Dlib_api_obj</span><span class="o">.</span><span class="n">load_image_file</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">image_path</span><span class="p">)</span>
        <span class="n">face_locations</span> <span class="o">=</span> <span class="n">Dlib_api_obj</span><span class="o">.</span><span class="n">face_locations</span><span class="p">(</span>
            <span class="n">resized_frame</span><span class="o">=</span><span class="n">dir_file_ndarray</span><span class="p">,</span>
            <span class="n">number_of_times_to_upsample</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">number_of_times_to_upsample</span><span class="p">,</span>
            <span class="n">mode</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">mode</span>  <span class="c1"># default is cnn.</span>
        <span class="p">)</span>
        <span class="n">default_file_data_list</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">npt</span><span class="o">.</span><span class="n">NDArray</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">]]</span> <span class="o">=</span> <span class="n">Dlib_api_obj</span><span class="o">.</span><span class="n">face_encodings</span><span class="p">(</span>
            <span class="n">deep_learning_model</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">deep_learning_model</span><span class="p">,</span>
            <span class="n">resized_frame</span><span class="o">=</span><span class="n">dir_file_ndarray</span><span class="p">,</span>
            <span class="n">face_location_list</span><span class="o">=</span><span class="n">face_locations</span><span class="p">,</span>
            <span class="n">num_jitters</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">num_jitters</span><span class="p">,</span>  <span class="c1"># default is 0.</span>
            <span class="n">model</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span>  <span class="c1"># default is small.</span>
        <span class="p">)</span>
        <span class="c1"># Returns None if no faces are detected.</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">default_file_data_list</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span>
        <span class="k">return</span> <span class="n">default_file_data_list</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span></div>


    <span class="k">def</span> <span class="nf">_get_cpu_temp</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Get cpu temperature.</span>

<span class="sd">        This method tries to get the temperature of the CPU by running the command &#39;sensors -u&#39; and using regular expressions to extract the value of &#39;temp1_input&#39;.</span>
<span class="sd">        If it is successful, the temperature is returned, otherwise 0.0 is returned and an error message is output to the log.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">temperature</span><span class="p">:</span> <span class="nb">str</span>
        <span class="n">cmd</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;sensors&#39;</span><span class="p">,</span> <span class="s1">&#39;-u&#39;</span><span class="p">]</span>
        <span class="n">result</span> <span class="o">=</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="n">stdout</span><span class="o">=</span><span class="n">subprocess</span><span class="o">.</span><span class="n">PIPE</span><span class="p">)</span>
        <span class="n">pattern</span> <span class="o">=</span> <span class="sa">r</span><span class="s1">&#39;Tctl:\n\s+temp1_input:\s+(\d+\.\d+)&#39;</span>
        <span class="n">match</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">pattern</span><span class="p">,</span> <span class="n">result</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">decode</span><span class="p">())</span>
        <span class="k">if</span> <span class="n">match</span><span class="p">:</span>
            <span class="n">temperature</span> <span class="o">=</span> <span class="n">match</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
            <span class="k">return</span> <span class="nb">float</span><span class="p">(</span><span class="n">temperature</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;Failed to get cpu temperature&quot;</span><span class="p">)</span>
            <span class="n">cnt</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">while</span> <span class="n">cnt</span> <span class="o">&lt;</span> <span class="mi">3</span><span class="p">:</span>
                <span class="n">cnt</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="n">subprocess</span><span class="o">.</span><span class="n">run</span><span class="p">([</span><span class="s1">&#39;notify-send&#39;</span><span class="p">,</span> <span class="s1">&#39;Failed to get cpu temperature&#39;</span><span class="p">])</span>
                <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">return</span> <span class="mf">0.0</span>

<div class="viewcode-block" id="Utils.temp_sleep">
<a class="viewcode-back" href="../../face01lib.html#face01lib.utils.Utils.temp_sleep">[ドキュメント]</a>
    <span class="k">def</span> <span class="nf">temp_sleep</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">temp</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">80.0</span><span class="p">,</span>
        <span class="n">sleep_time</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">60</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;temp_sleep : sleep time for cpu temperature.</span>

<span class="sd">        If the CPU temperature exceeds the value specified by the argument `temp`, it sleeps for the time specified by `sleep_time`.</span>
<span class="sd">        If the `sensors` command fails to get the CPU temperature, it will try to execute it 3 times at 1 second intervals. If it still can&#39;t get it, exit the program.</span>

<span class="sd">        Args:</span>
<span class="sd">            temp (float, optional): cpu temperature. Defaults to 80.0.</span>
<span class="sd">            sleep_time (int, optional): sleep time. Defaults to 60.</span>

<span class="sd">        Returns:</span>
<span class="sd">            None</span>

<span class="sd">        Note:</span>
<span class="sd">            The `sensors` and `notify-send` commands are required to use this method.</span>
<span class="sd">            The `sensors` command is included in the `lm-sensors` package.</span>
<span class="sd">            The `notify-send` command is included in the `libnotify-bin` package.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">temp</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="n">temp</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sleep_time</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="n">sleep_time</span>
        <span class="n">temperature</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_cpu_temp</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">temperature</span> <span class="o">==</span> <span class="mf">0.0</span><span class="p">:</span>
            <span class="n">exit</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
        <span class="k">while</span> <span class="n">temperature</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">temp</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;The temperature has exceeded </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">temp</span><span class="si">}</span><span class="s2"> degrees.&quot;</span><span class="p">)</span>
            <span class="c1"># print(&#39;The temperature has exceeded 80 degrees.&#39;)</span>
            <span class="n">subprocess</span><span class="o">.</span><span class="n">run</span><span class="p">([</span><span class="s1">&#39;notify-send&#39;</span><span class="p">,</span> <span class="sa">f</span><span class="s1">&#39;The temperature has exceeded </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">temp</span><span class="si">}</span><span class="s1"> degrees.&#39;</span><span class="p">])</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">subprocess</span><span class="o">.</span><span class="n">run</span><span class="p">([</span><span class="s1">&#39;play&#39;</span><span class="p">,</span> <span class="s1">&#39;-q&#39;</span><span class="p">,</span> <span class="s1">&#39;-v 1&#39;</span><span class="p">,</span> <span class="s1">&#39;/home/terms/bin/FACE01/voices/CPU_temp.wav&#39;</span><span class="p">])</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="k">pass</span>
            <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sleep_time</span><span class="p">)</span>
            <span class="n">temperature</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_cpu_temp</span><span class="p">()</span></div>


<div class="viewcode-block" id="Utils.resize_image">
<a class="viewcode-back" href="../../face01lib.html#face01lib.utils.Utils.resize_image">[ドキュメント]</a>
    <span class="k">def</span> <span class="nf">resize_image</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">img</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span>
        <span class="n">upper_limit_length</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">1024</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;resize_image : resize image.</span>

<span class="sd">        The input `np.ndarray` format image data is resized to fit the specified width or height. In this process, the aspect ratio is maintained by resizing based on the longer side of the width and height. The default maximum values for width and height are 1024px.</span>

<span class="sd">        Args:</span>
<span class="sd">            img (np.ndarray): image data.</span>
<span class="sd">            upper_limit_length (int, optional): upper limit length. Defaults to 1024.</span>

<span class="sd">        Returns:</span>
<span class="sd">            np.ndarray: resized image data.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">img</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span> <span class="o">=</span> <span class="n">img</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">upper_limit_length</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="n">upper_limit_length</span>
        <span class="n">height</span><span class="p">:</span> <span class="nb">int</span>
        <span class="n">width</span><span class="p">:</span> <span class="nb">int</span>
        <span class="n">resized_height</span><span class="p">:</span> <span class="nb">int</span>
        <span class="n">resized_width</span><span class="p">:</span> <span class="nb">int</span>

        <span class="kn">from</span> <span class="nn">math</span> <span class="kn">import</span> <span class="n">gcd</span>

        <span class="n">height</span><span class="p">,</span> <span class="n">width</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">img</span><span class="o">.</span><span class="n">shape</span><span class="p">[:</span><span class="mi">2</span><span class="p">]</span>

        <span class="k">if</span> <span class="n">height</span> <span class="o">&lt;</span> <span class="n">upper_limit_length</span> <span class="ow">and</span> <span class="n">width</span> <span class="o">&lt;</span> <span class="n">upper_limit_length</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">img</span>

        <span class="n">gcd_value</span> <span class="o">=</span> <span class="n">gcd</span><span class="p">(</span><span class="n">height</span><span class="p">,</span> <span class="n">width</span><span class="p">)</span>
        <span class="n">aspect_ratio_height</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="n">height</span> <span class="o">//</span> <span class="n">gcd_value</span>
        <span class="n">aspect_ratio_width</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="n">width</span> <span class="o">//</span> <span class="n">gcd_value</span>

        <span class="k">if</span> <span class="n">height</span> <span class="o">&gt;</span> <span class="n">width</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">height</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">upper_limit_length</span><span class="p">:</span>
                <span class="n">resized_height</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">upper_limit_length</span>
                <span class="n">resized_width</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">resized_height</span> <span class="o">*</span> <span class="n">aspect_ratio_width</span> <span class="o">/</span> <span class="n">aspect_ratio_height</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">width</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">upper_limit_length</span><span class="p">:</span>
                <span class="n">resized_width</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">upper_limit_length</span>
                <span class="n">resized_height</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">resized_width</span> <span class="o">*</span> <span class="n">aspect_ratio_height</span> <span class="o">/</span> <span class="n">aspect_ratio_width</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">cv2</span><span class="o">.</span><span class="n">resize</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">img</span><span class="p">,</span> <span class="p">(</span><span class="n">resized_width</span><span class="p">,</span> <span class="n">resized_height</span><span class="p">),</span> <span class="n">interpolation</span><span class="o">=</span><span class="n">cv2</span><span class="o">.</span><span class="n">INTER_AREA</span><span class="p">)</span></div>


    <span class="c1"># def data_augmentation(</span>
    <span class="c1">#         self,</span>
    <span class="c1">#         dir_path:str,</span>
    <span class="c1">#         size:int=224,</span>
    <span class="c1">#         num_jitters:int =10,</span>
    <span class="c1">#         initial_value: float = -0.1,</span>
    <span class="c1">#         closing_value: float = 0.1,</span>
    <span class="c1">#         step_value: float = 0.01,</span>
    <span class="c1">#     ):</span>
    <span class="c1">#     &quot;&quot;&quot;Data augmentation.</span>

    <span class="c1">#     This method accepts a directory path and recursively loads</span>
    <span class="c1">#     the images in that directory for data augmentation.</span>

    <span class="c1">#     Args:</span>
    <span class="c1">#         dir_path (str): directory path.</span>
    <span class="c1">#         size (int, optional): image size. Defaults to 224.</span>
    <span class="c1">#         num_jitters (int, optional): number of jitters. Defaults to 10.</span>
    <span class="c1">#         initial_value (float, optional): initial value. Defaults to -0.1.</span>
    <span class="c1">#         closing_value (float, optional): closing value. Defaults to 0.1.</span>
    <span class="c1">#         step_value (float, optional): step value. Defaults to 0.01.</span>

    <span class="c1">#     Return:</span>
    <span class="c1">#         None</span>

    <span class="c1">#     See Also:</span>
    <span class="c1">#         `dlib.jitter_image &lt;http://dlib.net/python/index.html#dlib_pybind11.jitter_image&gt;`_</span>
    <span class="c1">#     &quot;&quot;&quot;</span>
    <span class="c1">#     self.dir_path: str = dir_path</span>
    <span class="c1">#     self.size: int = size</span>
    <span class="c1">#     self.num_jitters: int = num_jitters</span>
    <span class="c1">#     self.initial_value: float = initial_value</span>
    <span class="c1">#     self.closing_value: float = closing_value</span>
    <span class="c1">#     self.step_value: float = step_value</span>

    <span class="c1">#     self.distort_barrel(</span>
    <span class="c1">#             dir_path=self.dir_path,</span>
    <span class="c1">#             size=self.size,</span>
    <span class="c1">#             initial_value=self.initial_value,</span>
    <span class="c1">#             closing_value=self.closing_value,</span>
    <span class="c1">#             step_value=self.step_value,</span>
    <span class="c1">#         )</span>
    <span class="c1">#     self.get_jitter_image(</span>
    <span class="c1">#         dir_path=self.dir_path,</span>
    <span class="c1">#         num_jitters=self.num_jitters,</span>
    <span class="c1">#         size=self.size,</span>
    <span class="c1">#         disturb_color=True,</span>
    <span class="c1">#         )</span>

<div class="viewcode-block" id="Utils.return_qr_code">
<a class="viewcode-back" href="../../face01lib.html#face01lib.utils.Utils.return_qr_code">[ドキュメント]</a>
    <span class="k">def</span> <span class="nf">return_qr_code</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">face_encodings</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;return_qr_code : return qr code.</span>

<span class="sd">        Summary:</span>
<span class="sd">            This method returns a QR code based on the face encoding list.</span>

<span class="sd">        Args:</span>
<span class="sd">            face_encodings (List): face encoding list.</span>

<span class="sd">        Returns:</span>
<span class="sd">            List: qr code.</span>

<span class="sd">        See Also:</span>
<span class="sd">            example/make_ID_card.py</span>

<span class="sd">        Results:</span>
<span class="sd">            .. image:: ../docs/img/ID_card_sample.png</span>
<span class="sd">                :scale: 50%</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="kn">import</span> <span class="nn">qrcode</span>
        <span class="kn">import</span> <span class="nn">base64</span>
        <span class="kn">import</span> <span class="nn">pickle</span>
        <span class="kn">import</span> <span class="nn">lzma</span>
        <span class="n">qr_img_list</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">face_encoding</span> <span class="ow">in</span> <span class="n">face_encodings</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">face_encoding</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span> <span class="o">=</span> <span class="n">face_encodings</span>
            <span class="c1"># 配列とそのメタデータ（形状とデータ型）を辞書にパック</span>
            <span class="n">data</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s1">&#39;array&#39;</span><span class="p">:</span> <span class="n">face_encoding</span><span class="o">.</span><span class="n">tolist</span><span class="p">(),</span>
                <span class="s1">&#39;shape&#39;</span><span class="p">:</span> <span class="n">face_encoding</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span>
                <span class="s1">&#39;dtype&#39;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">face_encoding</span><span class="o">.</span><span class="n">dtype</span><span class="p">),</span>
            <span class="p">}</span>

            <span class="c1"># データをバイト文字列に変換</span>
            <span class="n">byte_array</span> <span class="o">=</span> <span class="n">base64</span><span class="o">.</span><span class="n">b64encode</span><span class="p">(</span><span class="n">pickle</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">data</span><span class="p">))</span>
            <span class="c1"># 圧縮されたデータのバイト数を表示</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;byte_array data size: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">byte_array</span><span class="p">)</span><span class="si">}</span><span class="s2"> bytes&quot;</span><span class="p">)</span>

            <span class="c1"># データをlzmaで圧縮</span>
            <span class="n">compressed_data</span> <span class="o">=</span> <span class="n">lzma</span><span class="o">.</span><span class="n">compress</span><span class="p">(</span><span class="n">byte_array</span><span class="p">)</span>
            <span class="c1"># 圧縮されたデータのバイト数を表示</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Compressed data size: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">compressed_data</span><span class="p">)</span><span class="si">}</span><span class="s2"> bytes&quot;</span><span class="p">)</span>

            <span class="c1"># QRコード生成</span>
            <span class="n">qr</span> <span class="o">=</span> <span class="n">qrcode</span><span class="o">.</span><span class="n">QRCode</span><span class="p">(</span>
                <span class="n">version</span><span class="o">=</span><span class="mi">40</span><span class="p">,</span>
                <span class="n">error_correction</span><span class="o">=</span><span class="n">qrcode</span><span class="o">.</span><span class="n">constants</span><span class="o">.</span><span class="n">ERROR_CORRECT_L</span><span class="p">,</span>
                <span class="n">box_size</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span>
                <span class="n">border</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span>
            <span class="p">)</span>

            <span class="n">qr</span><span class="o">.</span><span class="n">add_data</span><span class="p">(</span><span class="n">compressed_data</span><span class="p">)</span>
            <span class="n">qr</span><span class="o">.</span><span class="n">make</span><span class="p">(</span><span class="n">fit</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

            <span class="n">qr_img</span> <span class="o">=</span> <span class="n">qr</span><span class="o">.</span><span class="n">make_image</span><span class="p">(</span><span class="n">fill</span><span class="o">=</span><span class="s1">&#39;black&#39;</span><span class="p">,</span> <span class="n">back_color</span><span class="o">=</span><span class="s1">&#39;white&#39;</span><span class="p">)</span>
            <span class="n">qr_img_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">qr_img</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">qr_img_list</span></div>
</div>

</pre></div>

           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2024, yKesamaru.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>